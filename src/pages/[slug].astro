---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogPost from '../components/BlogPost.astro';
import SEO from '../components/SEO.astro';

// Generate static paths for each post
export async function getStaticPaths() {
  const allPosts: CollectionEntry<'blog'>[] = await getCollection(
    'blog',
    ({ data }: CollectionEntry<'blog'>) => {
      return !data.draft;
    }
  );

  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

// Get the post data from the props
const { post } = Astro.props;

// Get previous and next posts
const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

// Get the canonical URL
const canonicalURL = new URL(post.slug, Astro.site);
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  type="article"
  image={post.data.heroImage}
  publishDate={post.data.pubDate}
  modifiedDate={post.data.updatedDate}
  author={post.data.author}
  next={nextPost ? `/${nextPost.slug}` : undefined}
  prev={prevPost ? `/${prevPost.slug}` : undefined}
  canonicalURL={canonicalURL}
>
  <article class="mx-auto max-w-3xl px-4 py-8">
    <BlogPost post={post}>
      <slot />
    </BlogPost>
  </article>
</BaseLayout>
